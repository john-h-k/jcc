name: Ubuntu RISC-V CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-24.04

    steps:
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev \
            gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev

      - name: Install RISC-V GNU Toolchain
        run: |
          git clone --recursive https://github.com/riscv/riscv-gnu-toolchain.git
          cd riscv-gnu-toolchain
          ./configure --prefix=/opt/riscv --with-arch=rv32imd --with-abi=ilp32d
          make -j$(nproc)
          sudo make install

      - name: Install Spike
        run: |
          git clone https://github.com/riscv/riscv-isa-sim.git
          cd riscv-isa-sim
          mkdir build && cd build
          ../configure --prefix=/opt/riscv
          make -j$(nproc)
          sudo make install

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run tests
        run: ./jcc.sh ci-test -T rv32i-unknown-elf



